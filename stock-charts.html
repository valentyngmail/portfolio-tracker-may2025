<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2-Week Price Dynamics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-white text-dark p-4">
  <h2>ðŸ“Š 2-Week Price Dynamics (in EUR)</h2>
  <canvas id="lineChart" height="100"></canvas>

  <script>
    const tickers = ['AAPL', 'GOOGL', 'META', 'TSLA', 'NFLX'];
    const fmpApiKey = 'U3IvlUHsgfPqwclA11fnwhCzptP9FtfE';

    async function getUsdToEurRate() {
      const cached = localStorage.getItem('eur-usd-chart-rate');
      const expiry = parseInt(localStorage.getItem('eur-usd-chart-expiry'), 10);
      const now = Date.now();
      if (cached && expiry && now < expiry) return parseFloat(cached);

      try {
        const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=EUR');
        const data = await res.json();
        const rate = data?.rates?.EUR || 0;
        if (rate > 0) {
          localStorage.setItem('eur-usd-chart-rate', rate);
          localStorage.setItem('eur-usd-chart-expiry', now + 86400000);
        }
        return rate;
      } catch {
        return 0;
      }
    }

    async function fetchHistoricalPrices(ticker) {
      const res = await fetch(`https://financialmodelingprep.com/api/v3/historical-price-full/${ticker}?timeseries=14&apikey=${fmpApiKey}`);
      const data = await res.json();
      return data?.historical?.map(item => ({ date: item.date, close: item.close })) || [];
    }

    async function drawChart() {
      const rate = await getUsdToEurRate();
      const datasets = [];
      let labels = [];

      for (const ticker of tickers) {
        const history = await fetchHistoricalPrices(ticker);
        if (!history.length) continue;

        const eurPrices = history.map(p => (p.close * rate).toFixed(2));
        if (labels.length === 0) {
          labels = history.map(p => p.date).reverse();
        }

        datasets.push({
          label: ticker,
          data: eurPrices.reverse(),
          borderColor: `hsl(${Math.random() * 360}, 70%, 50%)`,
          fill: false,
          tension: 0.3
        });
      }

      const ctx = document.getElementById('lineChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } },
          scales: {
            y: {
              title: { display: true, text: 'Price in EUR' },
              beginAtZero: false
            },
            x: {
              title: { display: true, text: 'Date' }
            }
          }
        }
      });
    }

    drawChart();
  </script>
</body>
</html>
