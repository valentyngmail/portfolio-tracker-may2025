<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Stock Portfolio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
</head>
<body class="bg-light text-dark p-4">
  <div class="container">
    <h1 class="mb-4">ðŸ“ˆ My Stock Portfolio 00</h1>

    <!-- Table to display portfolio data -->
    <table class="table table-bordered table-striped" id="portfolio-table">
      <thead class="table-dark">
        <tr>
          <th>Ticker</th>
          <th>Quantity</th>
          <th>Price (EUR)</th>
          <th>Date</th>
          <th>Total Price (EUR)</th>
          <th>Current Price (EUR)</th>
          <th>Current Total Value (EUR)</th>
          <th>Profit/Loss (EUR)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be populated by JavaScript -->
      </tbody>
    </table>

    <!-- Chart to show portfolio trends -->
    <canvas id="portfolio-chart"></canvas>
  </div>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Replace with your published Google Sheet CSV URL
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-YRIK8OyKyVRKfhn8PyK28VR2bnbaEP2PSyl-IpmffzNZo94BlQTO6qgmr2CAYV_H0Evj0t9otKdU/pub?output=csv';

    // Your RapidAPI Key and Host
    const apiKey = '97171e98camsh5eb470dfc81357dp1da351jsnd8907bf4c7b4';
    const apiHost = 'yh-finance.p.rapidapi.com';

    // Parse the CSV data from Google Sheets
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        console.log("Parsed data:", results.data);
        let tickers = getUniqueTickers(results.data);
        fetchStockData(tickers, results.data);
      },
      error: function(error) {
        console.error("Error parsing CSV data:", error.message);
      }
    });

    // Get unique tickers from the spreadsheet data
    function getUniqueTickers(data) {
      let tickers = [];
      data.forEach(row => {
        if (row.Ticker) {
          tickers.push(row.Ticker);
        }
      });
      return [...new Set(tickers)].join(',');
    }

    // Fetch stock data for all tickers in one API call
    function fetchStockData(tickers, portfolioData) {
      fetch(`https://yh-finance.p.rapidapi.com/market/v2/get-quotes?symbols=${tickers}`, {
        method: 'GET',
        headers: {
          'X-RapidAPI-Key': apiKey,
          'X-RapidAPI-Host': apiHost
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.quoteResponse && data.quoteResponse.result) {
          console.log("Stock Data:", data);
          updatePortfolioWithPrices(data, portfolioData);
          generateChart(data, portfolioData);
        } else {
          console.error("No valid stock data found.");
        }
      })
      .catch(error => {
        console.error("Error fetching stock data:", error);
      });
    }

    // Update the table with stock data (current price, total value, profit/loss)
    function updatePortfolioWithPrices(stockData, portfolioData) {
      const table = document.querySelector("#portfolio-table tbody");
      table.innerHTML = "";

      portfolioData.forEach(row => {
        let stockPrice = getStockPrice(stockData, row.Ticker);
        let currentTotalValue = stockPrice * row.Quantity;
        let profitLoss = currentTotalValue - parseFloat(row["Total Price (EUR)"].replace('â‚¬', '').replace(',', '.'));

        // Append data to the table
        table.innerHTML += `
          <tr>
            <td>${row.Ticker}</td>
            <td>${row.Quantity}</td>
            <td>${row["Price (EUR)"]}</td>
            <td>${row.Date}</td>
            <td>${row["Total Price (EUR)"]}</td>
            <td>${stockPrice.toFixed(2)} â‚¬</td>
            <td>${currentTotalValue.toFixed(2)} â‚¬</td>
            <td>${profitLoss.toFixed(2)} â‚¬</td>
          </tr>
        `;
      });
    }

    // Get the stock price from the fetched API data
    function getStockPrice(stockData, ticker) {
      let stock = stockData.quoteResponse.result.find(stock => stock.symbol === ticker);
      return stock ? stock.regularMarketPrice : 0;
    }

    // Generate the portfolio chart
    function generateChart(stockData, portfolioData) {
      const ctx = document.getElementById('portfolio-chart').getContext('2d');

      // Prepare data for the chart
      let labels = portfolioData.map(row => row.Ticker);
      let dataset = {
        labels: labels,
        datasets: []
      };

      portfolioData.forEach(row => {
        let stockPrice = getStockPrice(stockData, row.Ticker);
        let totalValue = stockPrice * row.Quantity;

        dataset.datasets.push({
          label: row.Ticker,
          data: [totalValue],
          borderColor: getRandomColor(),
          fill: false,
          tension: 0.1
        });
      });

      new Chart(ctx, {
        type: 'line',
        data: dataset,
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'category',
              labels: labels
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Generate random color for each stock line
    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }
  </script>
</body>
</html>
