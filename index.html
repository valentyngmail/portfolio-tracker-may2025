<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stock Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-light text-dark p-4">
  <div class="container">
    <h1>ðŸ“Š My Sold Stocks Tracker - </h1>
    <canvas id="portfolio-chart" class="my-4"></canvas>
  </div>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-YRIK8OyKyVRKfhn8PyK28VR2bnbaEP2PSyl-IpmffzNZo94BlQTO6qgmr2CAYV_H0Evj0t9otKdU/pub?output=csv';
    const fmpApiKey = 'U3IvlUHsgfPqwclA11fnwhCzptP9FtfE';
    let chart;

    function parseNumber(val) {
      return parseFloat(val.replace(',', '.').replace(/[^\d.-]/g, '')) || 0;
    }

    async function getEurRate() {
      try {
        const res = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=EUR');
        const data = await res.json();
        return data?.rates?.EUR || 0.93; // fallback if API fails
      } catch {
        return 0.93; // fallback on error
      }
    }

    async function fetchPrices(tickers, rate) {
      const url = `https://financialmodelingprep.com/api/v3/quote/${tickers.join(',')}?apikey=${fmpApiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      const prices = {};
      data.forEach(item => {
        prices[item.symbol] = item.price * (item.currency === 'USD' ? rate : 1);
      });
      return prices;
    }

    async function init() {
      const res = await fetch(csvUrl);
      const text = await res.text();
      const { data } = Papa.parse(text, { header: true });

      const tickers = [...new Set(data.map(row => row.Ticker).filter(Boolean))];
      const eurRate = await getEurRate();
      const prices = await fetchPrices(tickers, eurRate);

      const labels = [];
      const values = [];
      const colors = [];

      data.forEach(row => {
        const ticker = row.Ticker;
        const quantity = parseNumber(row.Quantity || "0");
        const price = prices[ticker] || 0;
        const value = quantity * price;
        if (value > 0) {
          labels.push(ticker);
          values.push(value);
          colors.push(`hsl(${Math.random() * 360}, 60%, 60%)`);
        }
      });

      const ctx = document.getElementById('portfolio-chart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
          }]
        },
        options: {
          responsive: true
        }
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
