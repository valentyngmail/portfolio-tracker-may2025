<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Stock Portfolio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    .positive { color: green; }
    .negative { color: red; }
  </style>
</head>
<body class="bg-light text-dark p-4">
  <div class="container">
    <h1 class="mb-4">ðŸ“ˆ My Stock Portfolio 9</h1>
    <table class="table table-bordered table-striped" id="portfolio-table">
      <thead class="table-dark">
        <tr>
          <th>Ticker</th>
          <th>Quantity</th>
          <th>Price (EUR)</th>
          <th>Date</th>
          <th>Total Price (EUR)</th>
          <th>Current Price (EUR)</th>
          <th>Current Value (EUR)</th>
          <th>Difference (EUR)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-YRIK8OyKyVRKfhn8PyK28VR2bnbaEP2PSyl-IpmffzNZo94BlQTO6qgmr2CAYV_H0Evj0t9otKdU/pub?output=csv';
    const RAPIDAPI_KEY = '97171e98camsh5eb470dfc81357dp1da351jsnd8907bf4c7b4';
    const exchangeRateURL = 'https://yh-finance.p.rapidapi.com/market/v2/get-quotes?symbols=EURUSD=X&region=US';
    let usdToEur = 0.93; // fallback

    function cleanNumber(str) {
      if (!str) return 0;
      return parseFloat(str.replace(/\./g, '').replace(',', '.').replace(/[^\d.-]/g, '')) || 0;
    }

    async function fetchExchangeRate() {
      try {
        const res = await fetch(exchangeRateURL, {
          method: 'GET',
          headers: {
            'X-RapidAPI-Key': RAPIDAPI_KEY,
            'X-RapidAPI-Host': 'yh-finance.p.rapidapi.com'
          }
        });
        const json = await res.json();
        const rate = json.quoteResponse?.result?.[0]?.regularMarketPrice;
        if (rate && !isNaN(rate)) {
          usdToEur = 1 / rate;
        }
      } catch (err) {
        console.warn("Using fallback exchange rate:", usdToEur);
      }
    }

    async function fetchCurrentPrice(ticker) {
      try {
        const url = `https://yh-finance.p.rapidapi.com/stock/v2/get-summary?symbol=${ticker}&region=US`;
        const res = await fetch(url, {
          method: 'GET',
          headers: {
            'X-RapidAPI-Key': RAPIDAPI_KEY,
            'X-RapidAPI-Host': 'yh-finance.p.rapidapi.com'
          }
        });
        const json = await res.json();
        return {
          price: json.price?.regularMarketPrice?.raw || null,
          currency: json.price?.currency || "USD"
        };
      } catch (error) {
        console.warn(`Error fetching price for ${ticker}:`, error);
        return { price: null, currency: "USD" };
      }
    }

    async function showPortfolio(data) {
      const table = document.querySelector("#portfolio-table tbody");
      table.innerHTML = "";

      await fetchExchangeRate();

      for (const row of data) {
        const ticker = row.Ticker?.trim();
        const quantity = cleanNumber(row["Quantity"]);
        const price = cleanNumber(row["Price (EUR)"]);
        const total = cleanNumber(row["Total Price (EUR)"]);
        const formattedDate = row.Date || "";

        if (!ticker || isNaN(quantity) || isNaN(price) || isNaN(total)) {
          console.warn("Skipping invalid row:", row);
          continue;
        }

        const { price: currentRaw, currency } = await fetchCurrentPrice(ticker);
        let currentPriceEUR = currentRaw;
        if (currency === "USD") currentPriceEUR *= usdToEur;

        const currentValue = currentPriceEUR * quantity;
        const diff = currentValue - total;
        const diffClass = diff > 0 ? "positive" : diff < 0 ? "negative" : "";

        table.innerHTML += `
          <tr>
            <td>${ticker}</td>
            <td>${quantity}</td>
            <td>${price.toFixed(2)} â‚¬</td>
            <td>${formattedDate}</td>
            <td>${total.toFixed(2)} â‚¬</td>
            <td>${currentPriceEUR?.toFixed(2)} â‚¬</td>
            <td>${currentValue?.toFixed(2)} â‚¬</td>
            <td class="${diffClass}">${diff?.toFixed(2)} â‚¬</td>
          </tr>`;
      }
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: function(results) {
        showPortfolio(results.data);
      }
    });
  </script>
</body>
</html>
