<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Sold Stocks Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body class="bg-light text-dark p-4">
  <div class="container">
    <h1 class="mb-4">ðŸ“ˆ My Sold Stocks Tracker</h1>

    <!-- Portfolio Table -->
    <table class="table table-bordered table-striped table-hover" id="portfolio-table">
      <thead class="table-dark">
        <tr>
          <th>Ticker</th>
          <th>Quantity</th>
          <th>Price (EUR)</th>
          <th>Date</th>
          <th>Total Price (EUR)</th>
          <th>Current Price (EUR)</th>
          <th>Current Total Value (EUR)</th>
          <th>Profit/Loss (EUR)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Embedded chart page -->
    <iframe src="stock-charts.html" width="100%" height="500" style="border: none;"></iframe>

    <!-- Pie Chart -->
    <div class="card my-4">
      <div class="card-body">
        <canvas id="portfolio-chart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-YRIK8OyKyVRKfhn8PyK28VR2bnbaEP2PSyl-IpmffzNZo94BlQTO6qgmr2CAYV_H0Evj0t9otKdU/pub?output=csv';
    const fmpApiKey = 'U3IvlUHsgfPqwclA11fnwhCzptP9FtfE';
    const currencyCacheKey = 'eur-usd-rate';
    const currencyCacheExpiryKey = 'eur-usd-rate-expiry';
    let chart;

    function parseNumber(value) {
      if (!value) return 0;
      return parseFloat(
        value.toString()
          .trim()
          .replace(/\./g, '')
          .replace(',', '.')
          .replace(/[^0-9.\-]/g, '')
      ) || 0;
    }

    function getUniqueTickers(data) {
      return [...new Set(data.map(row => row.Ticker?.trim()).filter(Boolean))];
    }

    async function getUsdToEurRate() {
      const cachedRate = localStorage.getItem(currencyCacheKey);
      const expiry = parseInt(localStorage.getItem(currencyCacheExpiryKey), 10);
      const now = Date.now();
      if (cachedRate && expiry && now < expiry) {
        return parseFloat(cachedRate);
      }

      try {
        const res = await fetch(`https://api.exchangerate.host/latest?base=USD&symbols=EUR`);
        const data = await res.json();
        const rate = data?.rates?.EUR || 0;
        if (rate > 0) {
          localStorage.setItem(currencyCacheKey, rate);
          localStorage.setItem(currencyCacheExpiryKey, now + 86400000); // cache for 1 day
        }
        return rate;
      } catch (err) {
        console.error('Failed to fetch currency rate, using fallback.');
        return 0.93; // Default fallback rate if the API fails
      }
    }

    async function fetchPricesFromFMP(tickers) {
      const results = {};
      try {
        const rate = await getUsdToEurRate();
        const url = `https://financialmodelingprep.com/api/v3/quote/${tickers.join(',')}?apikey=${fmpApiKey}`;
        const response = await fetch(url);
        const data = await response.json();
        data.forEach(stock => {
          const conversionRate = stock.currency === 'USD' ? rate : stock.currency === 'EUR' ? 1 : 0;
          results[stock.symbol] = stock.price * conversionRate;
        });
      } catch (error) {
        console.error('Error fetching FMP prices:', error);
      }
      return results;
    }

    function updatePortfolioTable(stockPrices, portfolioData) {
      const tbody = document.querySelector('#portfolio-table tbody');
      tbody.innerHTML = '';
      let totalProfitLoss = 0;

      portfolioData.forEach(row => {
        const ticker = row.Ticker;
        const quantity = parseNumber(row.Quantity);
        const buyPrice = parseNumber(row['Price (EUR)']);
        const totalPrice = parseNumber(row['Total Price (EUR)']);
        const currentPrice = stockPrices[ticker] || 0;
        const currentTotalValue = quantity * currentPrice;
        const profitLoss = totalPrice - currentTotalValue;
        totalProfitLoss += profitLoss;

        tbody.innerHTML += `
          <tr>
            <td>${ticker}</td>
            <td>${quantity.toFixed(2)}</td>
            <td>${buyPrice.toFixed(2)} â‚¬</td>
            <td>${row.Date || 'N/A'}</td>
            <td>${totalPrice.toFixed(2)} â‚¬</td>
            <td>${currentPrice.toFixed(2)} â‚¬</td>
            <td>${currentTotalValue.toFixed(2)} â‚¬</td>
            <td class="${profitLoss >= 0 ? 'text-success' : 'text-danger'}">${profitLoss.toFixed(2)} â‚¬</td>
          </tr>
        `;
      });

      tbody.innerHTML += `
        <tr class="fw-bold">
          <td colspan="7">Total</td>
          <td class="${totalProfitLoss >= 0 ? 'text-success' : 'text-danger'}">${totalProfitLoss.toFixed(2)} â‚¬</td>
        </tr>
      `;
    }

    function generatePieChart(stockPrices, portfolioData) {
      const ctx = document.getElementById('portfolio-chart').getContext('2d');
      const labels = [];
      const data = [];
      const colors = [];

      portfolioData.forEach(row => {
        const ticker = row.Ticker;
        const quantity = parseNumber(row.Quantity);
        const currentPrice = stockPrices[ticker] || 0;
        const value = quantity * currentPrice;
        if (value > 0) {
          labels.push(ticker);
          data.push(value);
          colors.push(`hsl(${Math.random() * 360}, 60%, 60%)`);
        }
      });

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets: [{ data, backgroundColor: colors }] },
        options: { responsive: true }
      });
    }

    async function init() {
      const response = await fetch(csvUrl);
      const csvText = await response.text();
      const results = Papa.parse(csvText, { header: true });
      const data = results.data.filter(row => row.Ticker);
      const tickers = getUniqueTickers(data);
      const stockPrices = await fetchPricesFromFMP(tickers);
      updatePortfolioTable(stockPrices, data);
      generatePieChart(stockPrices, data);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</body>
</html>
