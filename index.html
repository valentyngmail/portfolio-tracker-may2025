<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ“Š My Stock Portfolio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-light text-dark p-4">
  <div class="container">
    <h1 class="mb-4">ðŸ“ˆ My Stock Portfolio</h1>

    <!-- Chart Section -->
    <canvas id="portfolioChart" class="mb-4" height="100"></canvas>

    <!-- Table Section -->
    <table class="table table-bordered table-striped" id="portfolio-table">
      <thead class="table-dark">
        <tr>
          <th>Ticker</th>
          <th>Quantity</th>
          <th>Price (EUR)</th>
          <th>Date</th>
          <th>Total Price (EUR)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const apiKey = "97171e98camsh5eb470dfc81357dp1da351jsnd8907bf4c7b4";
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT-YRIK8OyKyVRKfhn8PyK28VR2bnbaEP2PSyl-IpmffzNZo94BlQTO6qgmr2CAYV_H0Evj0t9otKdU/pub?output=csv";
    const daysToShow = 7;

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      complete: async function(results) {
        const rows = results.data.filter(row => row.Ticker && row.Quantity);
        const tickers = [...new Set(rows.map(r => r.Ticker))];

        const allHistories = {};
        const portfolioHistory = {};

        for (const ticker of tickers) {
          const prices = await fetchStockHistory(ticker);
          allHistories[ticker] = prices;

          const quantity = rows
            .filter(r => r.Ticker === ticker)
            .reduce((sum, r) => sum + parseFloat(r.Quantity || 0), 0);

          Object.entries(prices).forEach(([date, price]) => {
            if (!portfolioHistory[date]) portfolioHistory[date] = {};
            portfolioHistory[date][ticker] = price * quantity;
          });
        }

        const latestPrices = Object.fromEntries(
          tickers.map(ticker => {
            const prices = allHistories[ticker];
            const lastDate = Object.keys(prices).sort().pop();
            return [ticker, prices[lastDate] || 0];
          })
        );

        updateTable(rows, latestPrices);
        renderChart(portfolioHistory, tickers);
      }
    });

    function fetchStockHistory(ticker) {
      const url = `https://yh-finance.p.rapidapi.com/stock/v3/get-historical-data?symbol=${ticker}&region=US`;

      return fetch(url, {
        method: 'GET',
        headers: {
          'X-RapidAPI-Key': apiKey,
          'X-RapidAPI-Host': 'yh-finance.p.rapidapi.com'
        }
      })
      .then(response => response.json())
      .then(data => {
        const prices = {};
        (data.prices || []).forEach(entry => {
          if (entry.date && entry.close) {
            const date = new Date(entry.date * 1000);
            const iso = date.toISOString().split('T')[0];
            prices[iso] = entry.close;
          }
        });
        return prices;
      })
      .catch(err => {
        console.error("Error fetching for", ticker, err);
        return {};
      });
    }

    function updateTable(rows, latestPrices) {
      const tbody = document.querySelector("#portfolio-table tbody");
      tbody.innerHTML = "";
      rows.forEach(row => {
        const ticker = row.Ticker;
        const quantity = parseFloat(row.Quantity || 0);
        const latestPrice = latestPrices[ticker] || 0;
        const total = (latestPrice * quantity).toFixed(2);
        tbody.innerHTML += `
          <tr>
            <td>${ticker}</td>
            <td>${quantity}</td>
            <td>${latestPrice.toFixed(2)}</td>
            <td>${new Date().toISOString().split('T')[0]}</td>
            <td>${total}</td>
          </tr>
        `;
      });
    }

    function renderChart(data, tickers) {
      const ctx = document.getElementById("portfolioChart").getContext("2d");
      const dates = Object.keys(data).sort();

      const totalValues = dates.map(date => {
        const dailyData = data[date];
        return Object.values(dailyData).reduce((sum, val) => sum + val, 0);
      });

      const datasets = [
        {
          label: "Total Portfolio",
          data: totalValues,
          backgroundColor: "rgba(33, 150, 243, 0.2)",
          borderColor: "#2196F3",
          borderWidth: 2,
          fill: true
        },
        ...tickers.map(ticker => {
          return {
            label: ticker,
            data: dates.map(date => data[date]?.[ticker] || 0),
            borderWidth: 1,
            fill: false
          };
        })
      ];

      new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: { display: true, text: "Portfolio Performance (Last 7 Days)" }
          },
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
  </script>


<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-YRIK8OyKyVRKfhn8PyK28VR2bnbaEP2PSyl-IpmffzNZo94BlQTO6qgmr2CAYV_H0Evj0t9otKdU/pub?output=csv';

  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(results) {
      console.log("Parsed data:", results.data);
      document.body.innerHTML += `<pre>${JSON.stringify(results.data, null, 2)}</pre>`;
    }
  });
</script>


  
</body>
</html>
