<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Stock Portfolio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-light text-dark p-4">
  <div class="container">
    <h1 class="mb-4">ðŸ“ˆ My Stock Portfolio - 1_1</h1>
    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

    <!-- Table to display portfolio data -->
    <table class="table table-bordered table-striped table-hover" id="portfolio-table">
      <thead class="table-dark">
        <tr>
          <th>Ticker</th>
          <th>Quantity</th>
          <th>Price (EUR)</th>
          <th>Date</th>
          <th>Total Price (EUR)</th>
          <th>Current Price (EUR)</th>
          <th>Current Total Value (EUR)</th>
          <th>Profit/Loss (EUR)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Chart to show portfolio trends -->
    <div class="card my-4">
      <div class="card-body">
        <canvas id="portfolio-chart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const alphaVantageKey = 'R8WOU4IBIHN1AIUV'; // Your Alpha Vantage key
    const yahooApiKey = '97171e98camsh5eb470dfc81357dp1da351jsnd8907bf4c7b4';
    const yahooApiHost = 'yh-finance.p.rapidapi.com';
    const iexCloudKey = 'YOUR_IEX_CLOUD_API_KEY'; // Your IEX Cloud key
    const fmpApiKey = 'U3IvlUHsgfPqwclA11fnwhCzptP9FtfE'; // Your Financial Modeling Prep key

    let chart;
    let usdToEurRate = 0; // Default to 0 if exchange rate fetch fails

    // Initialize portfolio data (mock data here)
    const portfolioData = [
      { Ticker: 'AAPL', Quantity: 10, 'Price (EUR)': 130, Date: '2023-01-01', 'Total Price (EUR)': 1300 },
      { Ticker: 'MSFT', Quantity: 15, 'Price (EUR)': 250, Date: '2023-01-01', 'Total Price (EUR)': 3750 },
      { Ticker: 'GOOGL', Quantity: 8, 'Price (EUR)': 2800, Date: '2023-01-01', 'Total Price (EUR)': 22400 }
    ];

    // Utility function to delay and respect API rate limits
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Show error message on page
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.classList.remove('d-none');
    }

    // Fetch USD to EUR exchange rate
    async function fetchExchangeRate() {
      try {
        const response = await fetch(`https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=USD&to_currency=EUR&apikey=${alphaVantageKey}`);
        const data = await response.json();
        if (data["Realtime Currency Exchange Rate"] && data["Realtime Currency Exchange Rate"]["5. Exchange Rate"]) {
          usdToEurRate = parseFloat(data["Realtime Currency Exchange Rate"]["5. Exchange Rate"]);
          console.log(`USD to EUR exchange rate: ${usdToEurRate}`);
        } else {
          console.warn('No exchange rate data:', data);
          showError('Failed to fetch USD to EUR exchange rate. Prices will show as 0 â‚¬.');
        }
      } catch (error) {
        console.error('Exchange rate error:', error);
        showError('Failed to fetch USD to EUR exchange rate. Prices will show as 0 â‚¬.');
      }
    }

    // Fetch stock data from Alpha Vantage in batches (batch size: 5 tickers per request)
    async function fetchFromAlphaVantageBatch(tickers) {
      const results = {};
      const batchSize = 5; // Max tickers per request
      for (let i = 0; i < tickers.length; i += batchSize) {
        const batch = tickers.slice(i, i + batchSize);
        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${batch.join(',')}&apikey=${alphaVantageKey}`;
        try {
          const response = await fetch(url);
          const data = await response.json();
          batch.forEach(ticker => {
            if (data["Global Quote"] && data["Global Quote"][ticker] && data["Global Quote"][ticker]["05. price"]) {
              results[ticker] = parseFloat(data["Global Quote"][ticker]["05. price"]);
            } else {
              console.warn(`No price data from Alpha Vantage for ${ticker}`);
            }
          });
        } catch (error) {
          console.error(`Error fetching from Alpha Vantage for batch ${batch}:`, error);
        }
        await delay(1000); // Delay between batches to respect rate limits (e.g., 5 requests per minute)
      }
      return results;
    }

    // Fetch stock data from Yahoo Finance in batches (batch size: 5 tickers per request)
    async function fetchFromYahooFinanceBatch(tickers) {
      const results = {};
      const batchSize = 5; // Max tickers per request
      for (let i = 0; i < tickers.length; i += batchSize) {
        const batch = tickers.slice(i, i + batchSize);
        const url = `https://yh-finance.p.rapidapi.com/market/v2/get-quotes?symbols=${batch.join(',')}`;
        try {
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'X-RapidAPI-Key': yahooApiKey,
              'X-RapidAPI-Host': yahooApiHost
            }
          });
          const data = await response.json();
          batch.forEach(ticker => {
            const stock = data.quoteResponse.result.find(item => item.symbol === ticker);
            if (stock && stock.regularMarketPrice) {
              results[ticker] = stock.regularMarketPrice;
            } else {
              console.warn(`No price data from Yahoo Finance for ${ticker}`);
            }
          });
        } catch (error) {
          console.error(`Error fetching from Yahoo Finance for batch ${batch}:`, error);
        }
        await delay(1000); // Delay between batches to respect rate limits
      }
      return results;
    }

    // Fetch stock data from Financial Modeling Prep API as a fallback
    async function fetchFromFmpApi(ticker) {
      try {
        const response = await fetch(`https://financialmodelingprep.com/api/v3/quote/${ticker}?apikey=${fmpApiKey}`);
        const data = await response.json();
        if (data && data[0] && data[0].price) {
          return data[0].price;
        } else {
          throw new Error('No price data from FMP API');
        }
      } catch (error) {
        console.error(`Error fetching from FMP API for ${ticker}:`, error);
        return null;
      }
    }

    // Fetch stock data with fallback mechanism (Alpha Vantage -> Yahoo Finance -> FMP)
    async function fetchStockData(tickers) {
      const stockData = {};

      // First try Alpha Vantage
      let data = await fetchFromAlphaVantageBatch(tickers);
      for (const ticker of tickers) {
        if (data[ticker]) {
          stockData[ticker] = data[ticker];
        }
      }

      // If no data from Alpha Vantage, try Yahoo Finance
      const missingTickers = tickers.filter(ticker => !stockData[ticker]);
      if (missingTickers.length > 0) {
        data = await fetchFromYahooFinanceBatch(missingTickers);
        for (const ticker of missingTickers) {
          if (data[ticker]) {
            stockData[ticker] = data[ticker];
          }
        }
      }

      // If still no data, try FMP API
      const finalMissingTickers = tickers.filter(ticker => !stockData[ticker]);
      if (finalMissingTickers.length > 0) {
        for (const ticker of finalMissingTickers) {
          const price = await fetchFromFmpApi(ticker);
          if (price) {
            stockData[ticker] = price;
          }
        }
      }

      if (Object.keys(stockData).length === 0) {
        showError('Failed to fetch stock data for all tickers.');
      } else {
        updatePortfolioWithPrices(stockData);
        generateChart(stockData);
      }
    }

    // Get unique tickers from CSV data
    function getUniqueTickers(data) {
      const tickers = data
        .filter(row => row.Ticker && typeof row.Ticker === 'string' && row.Ticker.trim())
        .map(row => row.Ticker.trim());
      return [...new Set(tickers)];
    }

    // Update table with stock data
    function updatePortfolioWithPrices(stockData) {
      const tbody = document.querySelector('#portfolio-table tbody');
      tbody.innerHTML = '';
      let totalProfitLoss = 0; // Track sum of Profit/Loss (EUR)

      portfolioData.forEach(row => {
        if (!row.Ticker || !row.Quantity || !row['Price (EUR)'] || !row['Total Price (EUR)']) return;

        const ticker = row.Ticker.trim();
        const currentPrice = stockData[ticker] * usdToEurRate || 0;

        const currentTotalValue = currentPrice * row.Quantity;
        const profitLoss = currentTotalValue - row['Total Price (EUR)'];
        totalProfitLoss += profitLoss;

        const rowElement = document.createElement('tr');
        rowElement.innerHTML = `
          <td>${row.Ticker}</td>
          <td>${row.Quantity}</td>
          <td>${row['Price (EUR)']}</td>
          <td>${row['Date']}</td>
          <td>${row['Total Price (EUR)']}</td>
          <td>${currentPrice.toFixed(2)}</td>
          <td>${currentTotalValue.toFixed(2)}</td>
          <td>${profitLoss.toFixed(2)}</td>
        `;
        tbody.appendChild(rowElement);
      });

      // Update total profit/loss
      const profitLossElement = document.createElement('tr');
      profitLossElement.innerHTML = `
        <td colspan="7" class="text-end"><strong>Total Profit/Loss:</strong></td>
        <td><strong>${totalProfitLoss.toFixed(2)}</strong></td>
      `;
      tbody.appendChild(profitLossElement);
    }

    // Generate chart for portfolio trends
    function generateChart(stockData) {
      const labels = Object.keys(stockData);
      const data = labels.map(ticker => stockData[ticker]);
      
      if (chart) {
        chart.destroy(); // Destroy existing chart if it exists
      }
      
      const ctx = document.getElementById('portfolio-chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Stock Prices (EUR)',
            data: data,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(tooltipItem) {
                  return tooltipItem.dataset.label + ': â‚¬' + tooltipItem.raw.toFixed(2);
                }
              }
            }
          }
        }
      });
    }

    // Initialize the app
    function init() {
      const tickers = getUniqueTickers(portfolioData); // Dynamically get tickers from portfolio
      fetchStockData(tickers);
      fetchExchangeRate();
    }

    // Start the app
    init();
  </script>
</body>
</html>
