<script>
  const exchangeRateURL = 'https://yh-finance.p.rapidapi.com/market/v2/get-quotes?region=US&symbols=EURUSD=X';
  let usdToEur = 0.93; // fallback

  async function fetchExchangeRate() {
    const options = {
      method: 'GET',
      headers: {
        'X-RapidAPI-Key': RAPIDAPI_KEY,
        'X-RapidAPI-Host': 'yh-finance.p.rapidapi.com'
      }
    };
    try {
      const res = await fetch(exchangeRateURL, options);
      const json = await res.json();
      const rate = json.quoteResponse?.result?.[0]?.regularMarketPrice;
      if (rate && !isNaN(rate)) {
        usdToEur = 1 / rate; // EUR per USD
      }
    } catch (err) {
      console.warn("Using fallback exchange rate:", usdToEur);
    }
  }

  async function fetchCurrentPrice(ticker) {
    const url = `https://yh-finance.p.rapidapi.com/stock/v2/get-summary?symbol=${ticker}&region=US`;
    const options = {
      method: 'GET',
      headers: {
        'X-RapidAPI-Key': RAPIDAPI_KEY,
        'X-RapidAPI-Host': 'yh-finance.p.rapidapi.com'
      }
    };
    try {
      const res = await fetch(url, options);
      const json = await res.json();
      return {
        price: json.price?.regularMarketPrice?.raw || null,
        currency: json.price?.currency || "USD"
      };
    } catch (error) {
      console.warn(`Price fetch error for ${ticker}:`, error);
      return { price: null, currency: "USD" };
    }
  }

  async function showPortfolio(data) {
    const table = document.querySelector("#portfolio-table tbody");
    table.innerHTML = "";

    await fetchExchangeRate();

    for (const row of data) {
      const ticker = row.Ticker;
      const quantity = parseFloat(row.Quantity.replace(",", "."));
      const price = parseFloat(row["Price (EUR)"].replace(/[^\d,.-]/g, "").replace(",", "."));
      const total = parseFloat(row["Total Price (EUR)"].replace(/[^\d,.-]/g, "").replace(",", "."));
      const dateParts = row.Date.split(".");
      const formattedDate = dateParts.length === 3 ? `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}` : row.Date;

      if (isNaN(quantity) || isNaN(price) || isNaN(total)) continue;

      const { price: currentRawPrice, currency } = await fetchCurrentPrice(ticker);
      let currentPriceEUR = currentRawPrice;

      if (currency === "USD") {
        currentPriceEUR *= usdToEur;
      }

      const currentValue = currentPriceEUR ? (currentPriceEUR * quantity) : null;
      const diff = currentValue !== null ? (currentValue - total) : null;
      const diffClass = diff > 0 ? "positive" : (diff < 0 ? "negative" : "");

      table.innerHTML += `
        <tr>
          <td>${ticker}</td>
          <td>${quantity}</td>
          <td>${price.toFixed(2)} €</td>
          <td>${formattedDate}</td>
          <td>${total.toFixed(2)} €</td>
          <td>${currentPriceEUR ? currentPriceEUR.toFixed(2) + " €" : "–"}</td>
          <td>${currentValue ? currentValue.toFixed(2) + " €" : "–"}</td>
          <td class="${diffClass}">${diff !== null ? diff.toFixed(2) + " €" : "–"}</td>
        </tr>
      `;
    }
  }
</script>
