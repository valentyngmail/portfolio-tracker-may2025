<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Stock Portfolio</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-light text-dark p-4">
  <div class="container">
    <h1 class="mb-4">ðŸ“ˆ My Stock Portfolio</h1>
    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

    <table class="table table-bordered table-striped table-hover" id="portfolio-table">
      <thead class="table-dark">
        <tr>
          <th>Ticker</th>
          <th>Quantity</th>
          <th>Price (EUR)</th>
          <th>Date</th>
          <th>Total Price (EUR)</th>
          <th>Current Price (EUR)</th>
          <th>Current Total Value (EUR)</th>
          <th>Profit/Loss (EUR)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="card my-4">
      <div class="card-body">
        <canvas id="portfolio-chart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT-YRIK8OyKyVRKfhn8PyK28VR2bnbaEP2PSyl-IpmffzNZo94BlQTO6qgmr2CAYV_H0Evj0t9otKdU/pub?output=csv';
    const alphaVantageKey = 'R8WOU4IBIHN1AIUV';
    const yahooApiKey = '97171e98camsh5eb470dfc81357dp1da351jsnd8907bf4c7b4';
    const yahooApiHost = 'yh-finance.p.rapidapi.com';
    const fmpApiKey = 'U3IvlUHsgfPqwclA11fnwhCzptP9FtfE';

    let usdToEurRate = 1;
    let chart;

    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      errorDiv.textContent = message;
      errorDiv.classList.remove('d-none');
    }

    async function fetchExchangeRate() {
      try {
        const res = await fetch(`https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=USD&to_currency=EUR&apikey=${alphaVantageKey}`);
        const data = await res.json();
        usdToEurRate = parseFloat(data?.['Realtime Currency Exchange Rate']?.['5. Exchange Rate'] || 1);
      } catch (err) {
        console.error("Exchange rate error:", err);
        showError("Failed to fetch USD to EUR exchange rate. Assuming 1.");
        usdToEurRate = 1;
      }
    }

    async function fetchPrices(tickers) {
      const stockData = {};

      // Batch Yahoo API
      const batchSize = 10;
      for (let i = 0; i < tickers.length; i += batchSize) {
        const batch = tickers.slice(i, i + batchSize).join(',');

        try {
          const response = await fetch(`https://cors-anywhere.herokuapp.com/https://yh-finance.p.rapidapi.com/market/v2/get-quotes?symbols=${batch}&region=US`, {
            method: 'GET',
            headers: {
              'X-RapidAPI-Key': yahooApiKey,
              'X-RapidAPI-Host': yahooApiHost
            }
          });
          const data = await response.json();
          if (data?.quoteResponse?.result) {
            data.quoteResponse.result.forEach(item => {
              stockData[item.symbol] = item.regularMarketPrice * usdToEurRate;
            });
          } else {
            console.warn('Yahoo response error:', data);
          }
        } catch (error) {
          console.warn(`Yahoo batch fetch failed for ${batch}.`, error);
        }
      }

      // Fallback to FMP if needed
      const missingTickers = tickers.filter(t => !stockData[t]);
      for (const ticker of missingTickers) {
        try {
          const response = await fetch(`https://financialmodelingprep.com/api/v3/quote/${ticker}?apikey=${fmpApiKey}`);
          const data = await response.json();
          if (Array.isArray(data) && data.length > 0) {
            stockData[ticker] = parseFloat(data[0].price) * usdToEurRate;
          }
        } catch (error) {
          console.warn(`FMP fallback failed for ${ticker}`, error);
        }
      }

      return stockData;
    }

    function updateTable(data, stockData) {
      const tbody = document.querySelector('#portfolio-table tbody');
      tbody.innerHTML = '';
      let totalPL = 0;

      data.forEach(row => {
        const ticker = row.Ticker?.trim();
        const quantity = parseFloat(row.Quantity) || 0;
        const buyPrice = parseFloat(row['Price (EUR)']) || 0;
        const totalPrice = parseFloat(row['Total Price (EUR)']) || quantity * buyPrice;
        const currentPrice = stockData[ticker] || 0;
        const currentTotal = quantity * currentPrice;
        const pl = currentTotal - totalPrice;
        totalPL += pl;

        tbody.innerHTML += `
          <tr>
            <td>${ticker}</td>
            <td>${quantity.toFixed(2)}</td>
            <td>${buyPrice.toFixed(2)} â‚¬</td>
            <td>${row.Date || 'N/A'}</td>
            <td>${totalPrice.toFixed(2)} â‚¬</td>
            <td>${currentPrice.toFixed(2)} â‚¬</td>
            <td>${currentTotal.toFixed(2)} â‚¬</td>
            <td class="${pl >= 0 ? 'text-success' : 'text-danger'}">${pl.toFixed(2)} â‚¬</td>
          </tr>
        `;
      });

      tbody.innerHTML += `
        <tr class="fw-bold">
          <td colspan="7">Total</td>
          <td class="${totalPL >= 0 ? 'text-success' : 'text-danger'}">${totalPL.toFixed(2)} â‚¬</td>
        </tr>
      `;
    }

    function generateChart(stockData, data) {
      const ctx = document.getElementById('portfolio-chart').getContext('2d');
      const datasets = data.map(row => {
        const value = (stockData[row.Ticker?.trim()] || 0) * (parseFloat(row.Quantity) || 0);
        return {
          label: row.Ticker,
          data: [value],
          borderColor: `rgba(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255}, 1)`,
          backgroundColor: `rgba(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255}, 0.2)`,
          tension: 0.3
        };
      });

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Portfolio'],
          datasets
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    async function init() {
      await fetchExchangeRate();
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: async function(results) {
          const data = results.data.filter(row => row.Ticker && row.Quantity);
          const tickers = [...new Set(data.map(row => row.Ticker?.trim()))];
          if (tickers.length === 0) {
            showError('No valid tickers found in CSV.');
            return;
          }
          const stockData = await fetchPrices(tickers);
          updateTable(data, stockData);
          generateChart(stockData, data);
        },
        error: function(err) {
          console.error('CSV parse error:', err);
          showError('Failed to parse CSV.');
        }
      });
    }

    init();
  </script>
</body>
</html>
